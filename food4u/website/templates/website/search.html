{% extends 'website/base.html' %}

{% block content %}
<main class="container" style="
background-color: var(--color-accent1); 
padding: 2rem; 
border-radius: 0.5rem;
margin-top: 2rem;
">
<h2>Find Local Businesses</h2>
<p>Use the filters below to refine your search.</p>

<!-- Search Form -->
<form id="searchForm" action="/search/" method="get">
  <!-- Search bar -->
  <label for="q">Search</label>
  <input 
    type="search" 
    id="q" 
    name="q" 
    placeholder="Enter your search term..." 
    required
  >

  <!-- Industry filter -->
  <label for="industry">Industry</label>
  <select id="industry" name="industry">
    <option value="">Any</option>
    <option value="restaurant">Restaurant</option>
    <option value="bakery">Bakery</option>
    <option value="cafe">Cafe</option>
    <option value="grocery">Grocery</option>
    <!-- Add more industries as needed -->
  </select>

  <!-- Location filter (km) -->
  <label for="location">Location (km)</label>
  <input 
    type="number" 
    id="location" 
    name="location" 
    min="1" 
    max="1000" 
    value="100"
  >

  <div style="display: flex; gap: 1rem;">
    <div>
      <label for="rating_min">Rating Min</label>
      <input 
        type="number" 
        id="rating_min" 
        name="rating_min" 
        min="1" 
        max="5" 
        value="1"
      >
    </div>
    <div>
      <label for="rating_max">Rating Max</label>
      <input 
        type="number" 
        id="rating_max" 
        name="rating_max" 
        min="1" 
        max="5" 
        value="5"
      >
    </div>
  </div>

  <!-- Hide No Rating -->
  <label for="no_rating">
    <input 
      type="checkbox" 
      id="no_rating" 
      name="no_rating" 
      value="true"
    >
    Hide listings with no rating
  </label>

  <!-- Submit button -->
  <button type="submit">Search</button>
</form>
</main>

<!-- OVERLAY for Search Results -->
<div id="searchResults" class="overlay hidden">
<article class="overlay-content container">
  <header>
    <h3>Search Results</h3>
  </header>
  <section id="resultsGrid" class="grid"></section>
  <footer style="text-align: right;">
    <button class="secondary" id="closeOverlay">Close</button>
  </footer>
</article>
</div>

<!-- MODAL for Product Details -->
<div id="productModal" class="modal hidden">
<article class="modal-content container">
  <header>
    <h4 id="modalProductName"></h4>
  </header>
  <section>
    <p id="modalProductDescription"></p>
    <p id="modalProductPrice"></p>
    <!-- Placeholder for photos -->
    <div id="modalProductPhotos" class="grid"></div>
    <!-- Placeholder for supplier info -->
    <div id="modalSupplierInfo"></div>
  </section>
  <footer style="text-align: right;">
    <button class="secondary" id="closeModal">Close</button>
  </footer>
</article>
</div>

<style>

/* Overlay (full-screen) styling */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 2rem;
  overflow-y: auto;
  z-index: 999; /* Above normal content */
}
.overlay-content {
  background-color: var(--color-background, #F4FDD9);
  border-radius: 0.5rem;
  padding: 1rem;
  width: 100%;
  max-width: 800px;
}
.hidden {
  display: none !important;
}

/* Modal styling (similar approach) */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 2rem;
  overflow-y: auto;
  z-index: 1000; /* Above overlay */
}
.modal-content {
  background-color: var(--color-background, #F4FDD9);
  border-radius: 0.5rem;
  padding: 1rem;
  width: 100%;
  max-width: 600px;
}

/* Grid layout for results and photos */
.grid {
  display: grid;
  gap: 1rem;
}
/* Example: show 3 columns on larger screens */
@media (min-width: 768px) {
  .grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Example styling for product cards */
.product-card {
  background-color: var(--color-accent2, #FFE8C2);
  border-radius: 0.5rem;
  padding: 1rem;
  cursor: pointer;
}
.product-card:hover {
  background-color: var(--color-accent3, #F0A868);
  color: #fff;
}
</style>

<script>
// Overlay and Modal Elements
const searchResultsOverlay = document.getElementById('searchResults');
const closeOverlayBtn = document.getElementById('closeOverlay');
const resultsGrid = document.getElementById('resultsGrid');

const productModal = document.getElementById('productModal');
const closeModalBtn = document.getElementById('closeModal');
const modalProductName = document.getElementById('modalProductName');
const modalProductDescription = document.getElementById('modalProductDescription');
const modalProductPrice = document.getElementById('modalProductPrice');
const modalProductPhotos = document.getElementById('modalProductPhotos');
const modalSupplierInfo = document.getElementById('modalSupplierInfo');

// Close overlay
closeOverlayBtn.addEventListener('click', () => {
  searchResultsOverlay.classList.add('hidden');
});

// Close modal
closeModalBtn.addEventListener('click', () => {
  productModal.classList.add('hidden');
});

// Handle product click -> open modal
function openProductModal(product) {
  // Populate modal fields
  modalProductName.textContent = product.name || 'Untitled';
  modalProductDescription.textContent = product.description || 'No description';
  modalProductPrice.textContent = product.price ? `Price: $${product.price}` : '';
  modalSupplierInfo.textContent = product.supplier ? `Supplier: ${product.supplier}` : '';

  // Placeholder for photos
  modalProductPhotos.innerHTML = '';
  if (product.photos && product.photos.length > 0) {
    product.photos.forEach(photoUrl => {
      const img = document.createElement('img');
      img.src = photoUrl;
      img.alt = product.name;
      img.style.width = '100%';
      modalProductPhotos.appendChild(img);
    });
  }

  productModal.classList.remove('hidden');
}

// Handle search form submission (AJAX)
const searchForm = document.getElementById('searchForm');
searchForm.addEventListener('submit', (e) => {
  e.preventDefault(); // Prevent full page reload

  // Build the query string from form fields
  const formData = new FormData(searchForm);
  const params = new URLSearchParams(formData);
  // Example: if your backend endpoint is /search/api/
  const fetchUrl = '/search/api/?' + params.toString();

  // Fetch JSON from backend
  fetch(fetchUrl)
    .then(response => response.json())
    .then(data => {
      // data should be an array of products, e.g.:
      // [
      //   {
      //     "name": "Product A",
      //     "description": "Description A",
      //     "price": "9.99",
      //     "supplier": "Supplier A",
      //     "photos": ["url1.jpg", "url2.jpg"]
      //   },
      //   ...
      // ]
      displaySearchResults(data);
    })
    .catch(err => {
      console.error('Error fetching search results:', err);
    });
});

// Display the results in the overlay
function displaySearchResults(products) {
  resultsGrid.innerHTML = '';

  if (!products || products.length === 0) {
    resultsGrid.innerHTML = '<p>No results found.</p>';
  } else {
    products.forEach(product => {
      const card = document.createElement('div');
      card.classList.add('product-card');
      card.innerHTML = `
        <h4>${product.name || 'Untitled'}</h4>
        <p>${product.description || ''}</p>
      `;
      card.addEventListener('click', () => openProductModal(product));
      resultsGrid.appendChild(card);
    });
  }

  // Show the overlay
  searchResultsOverlay.classList.remove('hidden');
}
</script>
{% endblock %}
