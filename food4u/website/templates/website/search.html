{% extends 'website/base.html' %}

{% block content %}
<main 
  class="container" 
  style="
    display: flex; 
    gap: 2rem; 
    margin-top: 2rem; 
    margin-bottom: 2rem;
    width: 90%;
    max-width: 1200px;
"
>
  <!-- LEFT COLUMN: Sticky Search Bar -->
  <aside 
    style="
      flex: 0 0 300px;
      position: sticky; 
      top: 1rem;
      align-self: flex-start;
      background-color: var(--color-accent1, #E4FFE1);
      padding: 1rem;
      border-radius: 0.5rem;
      height: fit-content;
    "
  >
    <h2>Find Local Businesses</h2>
    <p>Use the filters below to refine your search.</p>

    <!-- Search Form -->
    <form id="searchForm" action="/search/" method="get" style="display: flex; flex-direction: column; gap: 0.75rem;">
      <!-- Search bar -->

      <!-- Industry filter -->
      <label for="industry">Industry</label>
      <select id="industry" name="industry">
        <option value="">Any</option>
        <option value="restaurant">Restaurant</option>
        <option value="bakery">Bakery</option>
        <option value="cafe">Cafe</option>
        <option value="grocery">Grocery</option>
        <!-- Add more industries as needed -->
      </select>

      <!-- Location filter (km) -->
      <label for="location">Location (km)</label>
      <input 
        type="number" 
        id="location" 
        name="location" 
        min="1" 
        max="1000" 
        value="100"
      >

      <!-- Rating Range -->
      <div style="display: flex; gap: 1rem;">
        <div>
          <label for="rating_min">Rating Min</label>
          <input 
            type="number" 
            id="rating_min" 
            name="rating_min" 
            min="1" 
            max="5" 
            value="1"
          >
        </div>
        <div>
          <label for="rating_max">Rating Max</label>
          <input 
            type="number" 
            id="rating_max" 
            name="rating_max" 
            min="1" 
            max="5" 
            value="5"
          >
        </div>
      </div>

      <!-- Hide No Rating -->
      <label for="no_rating">
        <input 
          type="checkbox" 
          id="no_rating" 
          name="no_rating" 
          value="true"
        >
        Hide listings with no rating
      </label>

      <!-- Submit button -->
      <button type="submit">Search</button>
    </form>
  </aside>

  <!-- CENTER COLUMN: Scrollable List of Products -->
  <section 
    id="productListContainer"
    style="
      flex: 1; 
      background-color: var(--color-accent1, #E4FFE1); 
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-y: auto; 
      max-height: calc(100vh - 4rem); /* or adjust as needed */
    "
  >
    <h2>Available Products</h2>
    <!-- This is where all products will be displayed -->
    <div id="productList" style="display: flex; flex-direction: column; gap: 1rem;"></div>
  </section>
</main>

<style>
/* Minimal styling to make items look like a marketplace list */
.product-item {
  background-color: var(--color-accent2, #FFE8C2);
  padding: 1rem;
  border-radius: 0.5rem;
  display: flex;
  flex-direction: row;
  gap: 1rem;
  align-items: center;
  transition: background-color 0.2s ease;
}
.product-item:hover {
  background-color: var(--color-accent3, #F0A868);
  color: #fff;
}

.product-item img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 0.25rem;
}

.product-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.product-details h4 {
  margin: 0;
}
</style>

<script>
// On page load, fetch default products
window.addEventListener('DOMContentLoaded', () => {
  fetchProducts();
});

// Handle form submission (AJAX)
const searchForm = document.getElementById('searchForm');
searchForm.addEventListener('submit', (e) => {
  e.preventDefault();
  fetchProducts();
});

// Build the query string and fetch from server
function fetchProducts() {
  const formData = new FormData(searchForm);
  const params = new URLSearchParams(formData);

  // Example: if your backend endpoint is /search/api/
  // You can also add a timestamp to avoid caching:
  const fetchUrl = '/search_results?' + params.toString() + '&t=' + Date.now();

  fetch(fetchUrl, { cache: 'no-store' })
    .then(response => response.json())
    .then(data => {
      displayProducts(data);
    })
    .catch(err => {
      console.error('Error fetching products:', err);
    });
}

function displayProducts(products) {
  const productList = document.getElementById('productList');
  productList.innerHTML = ''; // Clear previous results

  if (!products || products.length === 0) {
    productList.innerHTML = '<p>No products found.</p>';
    return;
  }

  products.forEach(item => {
    const productItem = document.createElement('div');
    productItem.classList.add('product-item');
    
    // Example fallback image
    productItem.innerHTML = `
    <a href="/product/${item.id}">
      <div class="product-details">
        <h4>${item.name || 'Unnamed Product'}</h4>
        <p>${item.description || 'No description provided.'}</p>
        <p><strong>Price:</strong> $${item.price || 'N/A'}</p>
        <p><strong>Rating:</strong> ${item.rating || 'N/A'}</p>
      </div></a>
    `;

    productList.appendChild(productItem);
  });
}
</script>
{% endblock %}
